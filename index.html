<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة متابعة العمليات - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; }
        .card { border: none; shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stat-card { border-right: 5px solid #0d6efd; background: white; padding: 20px; border-radius: 8px; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #333; }
        .stat-label { color: #666; font-size: 0.9rem; }
        #loading { text-align: center; margin-top: 50px; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">لوحة متابعة سير العمل</h2>
        <span class="badge bg-secondary" id="last-update">جاري التحميل...</span>
    </div>

    <div id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">جاري جلب البيانات من ملف العمل...</p>
    </div>

    <div id="dashboard" style="display:none;">
        
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #0d6efd;">
                    <div class="stat-number" id="total-rows">0</div>
                    <div class="stat-label">إجمالي السجلات</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #198754;">
                    <div class="stat-number" id="site-work">0</div>
                    <div class="stat-label">عمل بالموقع</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #ffc107;">
                    <div class="stat-number" id="office-work">0</div>
                    <div class="stat-label">عمل مكتبي</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #dc3545;">
                    <div class="stat-number" id="unique-names">0</div>
                    <div class="stat-label">عدد الموظفين</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="card-title">توزيع العمل (موقع vs مكتبي)</h5>
                    <canvas id="workTypeChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="card-title">النشاط حسب المنطقة</h5>
                    <canvas id="regionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-3 mt-4">
            <h5 class="card-title mb-3">آخر السجلات المضافة</h5>
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="dataTable">
                    <thead class="table-dark">
                        <tr>
                            <th>التاريخ</th>
                            <th>الاسم</th>
                            <th>المنطقة</th>
                            <th>نوع العمل</th>
                            <th>حالة اليوم</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // الرابط المباشر من جوجل (يعمل مباشرة لأنه منشور كـ Web Page)
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAtkh9IahXDn646StIUXI46U8d1qiTajH5DAXUNY11ZL0UZa_xjHEgg5QcutZc6QFfL9C33MFtFSwH/pub?output=csv";

    function init() {
        Papa.parse(sheetURL, {
            download: true,
            header: true,
            skipEmptyLines: true, // تخطي الأسطر الفارغة تلقائياً
            complete: function(results) {
                if (results.data && results.data.length > 0) {
                    processData(results.data);
                } else {
                    alert("الملف فارغ أو لم يتم تحميل البيانات.");
                }
            },
            error: function(err) {
                alert("فشل التحميل. تأكد من أنك لا تفتح الملف بالنقر المزدوج (file://)، بل استخدم سيرفر محلي.");
                console.error("Papa Parse Error:", err);
            }
        });
    }

    function processData(data) {
        // تنظيف البيانات (التأكد من وجود الاسم)
        data = data.filter(row => row['الاسم'] && row['الاسم'].trim() !== "");

        // 1. حساب الإحصائيات
        const totalRows = data.length;
        const siteWork = data.filter(r => r['نوع العمل'] && r['نوع العمل'].includes('موقع')).length;
        const officeWork = data.filter(r => r['نوع العمل'] && r['نوع العمل'].includes('مكتب')).length;
        
        // حساب الأسماء الفريدة
        const uniqueNames = [...new Set(data.map(item => item['الاسم']))].length;

        // تحديث الواجهة
        document.getElementById('total-rows').innerText = totalRows;
        document.getElementById('site-work').innerText = siteWork;
        document.getElementById('office-work').innerText = officeWork;
        document.getElementById('unique-names').innerText = uniqueNames;
        document.getElementById('last-update').innerText = "آخر تحديث: " + new Date().toLocaleDateString('ar-EG');

        // 2. رسم المخططات
        renderCharts(siteWork, officeWork, data);

        // 3. ملء الجدول (آخر 10 سجلات)
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = ""; // تفريغ الجدول أولاً
        
        const recentData = data.slice().reverse().slice(0, 10); 
        
        recentData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row['التاريخ'] || '-'}</td>
                <td>${row['الاسم'] || '-'}</td>
                <td>${row['المنطقة'] || '-'}</td>
                <td><span class="badge ${row['نوع العمل'] && row['نوع العمل'].includes('موقع') ? 'bg-success' : 'bg-warning text-dark'}">${row['نوع العمل'] || '-'}</span></td>
                <td>${row['حالة اليوم'] || '-'}</td>
            `;
            tableBody.appendChild(tr);
        });

        // إخفاء التحميل وإظهار اللوحة
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
    }

    function renderCharts(site, office, data) {
        // إذا كانت المخططات موجودة مسبقاً، قم بتدميرها لتجنب التكرار عند إعادة التحميل
        // (في هذا الكود البسيط، الصفحة تعمل مرة واحدة، لكن للتنويه)

        // Work Type Chart (Pie)
        new Chart(document.getElementById('workTypeChart'), {
            type: 'doughnut',
            data: {
                labels: ['عمل بالموقع', 'عمل مكتبي'],
                datasets: [{
                    data: [site, office],
                    backgroundColor: ['#198754', '#ffc107']
                }]
            }
        });

        // Region Chart (Bar)
        const regions = {};
        data.forEach(row => {
            const reg = row['المنطقة'];
            if(reg) regions[reg] = (regions[reg] || 0) + 1;
        });

        new Chart(document.getElementById('regionChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(regions),
                datasets: [{
                    label: 'عدد الأنشطة',
                    data: Object.values(regions),
                    backgroundColor: '#0d6efd'
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // تشغيل الدالة
    init();
</script>

</body>
</html>