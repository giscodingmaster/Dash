المشكلة غالباً سببها اختلاف بسيط في كتابة عناوين الأعمدة في ملف Google Sheet وبين الكود.
أكثر الأخطاء شيوعاً هي:

وجود مسافات زائدة: (مثلاً " نوع الجهاز " بدلاً من "نوع الجهاز").

اختلاف التسمية: (مثلاً "المواصلات" بدلاً من "وسيلة المواصلات").

لقد قمت بتحديث الكود ليقوم بـ 3 حلول ذكية:

إزالة المسافات تلقائياً: سيقوم الكود بتنظيف العناوين من أي مسافات زائدة.

البحث المرن: سيحاول الكود البحث عن بدائل (مثلاً لو لم يجد "وسيلة المواصلات" سيبحث عن "المواصلات").

فحص الأعمدة: عند التشغيل، إذا لم تظهر البيانات، افتح "Console" في المتصفح لترى أسماء الأعمدة التي قرأها الكود بالفعل.

الكود المصحح (النسخة النهائية):
code
Html
play_circle
download
content_copy
expand_less
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة متابعة العمليات - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; font-size: 0.9rem; }
        .card { border: none; shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stat-card { border-right: 5px solid #0d6efd; background: white; padding: 15px; border-radius: 8px; }
        .stat-number { font-size: 1.8rem; font-weight: bold; color: #333; }
        .stat-label { color: #666; font-size: 0.85rem; }
        #loading { text-align: center; margin-top: 50px; }
        .filter-section { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-responsive { max-height: 650px; overflow-y: auto; }
        thead th { position: sticky; top: 0; z-index: 1020; background-color: #212529; color: white; }
        .badge { font-size: 0.8rem; padding: 0.5em 0.7em; }
    </style>
</head>
<body>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 px-3">
        <h3 class="fw-bold text-primary">لوحة متابعة سير العمل اليومي</h3>
        <span class="badge bg-secondary" id="last-update">جاري التحميل...</span>
    </div>

    <!-- قسم الفلترة -->
    <div class="container px-3">
        <div class="filter-section">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="dateFilter" class="form-label fw-bold">تحديد يوم للعرض:</label>
                    <input type="date" id="dateFilter" class="form-control">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 mb-2 mb-md-0" onclick="applyDateFilter()">عرض تفاصيل هذا اليوم</button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilter()">عرض الكل</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">جاري جلب البيانات... يرجى الانتظار</p>
    </div>

    <div id="dashboard" style="display:none;" class="px-3">
        
        <!-- الإحصائيات -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #0d6efd;">
                    <div class="stat-number" id="total-rows">0</div>
                    <div class="stat-label">إجمالي العمليات</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #198754;">
                    <div class="stat-number" id="site-work">0</div>
                    <div class="stat-label">زيارات ميدانية</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #ffc107;">
                    <div class="stat-number" id="office-work">0</div>
                    <div class="stat-label">عمل مكتبي</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #dc3545;">
                    <div class="stat-number" id="unique-names">0</div>
                    <div class="stat-label">الموظفين</div>
                </div>
            </div>
        </div>

        <!-- الجدول التفصيلي -->
        <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title fw-bold text-dark" id="tableTitle">سجل التفاصيل اليومية</h5>
                <button class="btn btn-sm btn-outline-info" onclick="debugColumns()">فحص أسماء الأعمدة</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-bordered table-striped align-middle" id="dataTable">
                    <thead class="table-dark">
                        <tr>
                            <th>التاريخ</th>
                            <th>الشركة</th>
                            <th>الاسم</th>
                            <th>نوع العمل</th>
                            <th>حالة اليوم</th>
                            <th style="min-width: 250px;">تفاصيل النشاط</th>
                            <th>نوع الجهاز</th>
                            <th>وسيلة المواصلات</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- المخططات البيانية -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card p-3">
                    <h6 class="card-title">توزيع نوع العمل</h6>
                    <div style="height: 250px; display: flex; justify-content: center;">
                        <canvas id="workTypeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <h6 class="card-title">العمليات حسب الشركة</h6>
                    <div style="height: 250px;">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAtkh9IahXDn646StIUXI46U8d1qiTajH5DAXUNY11ZL0UZa_xjHEgg5QcutZc6QFfL9C33MFtFSwH/pub?output=csv";
    
    let allData = []; 
    let chart1Instance = null;
    let chart2Instance = null;
    let foundHeaders = []; // لحفظ أسماء الأعمدة التي وجدناها فعلياً

    function init() {
        Papa.parse(sheetURL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            // هذا السطر مهم جداً: يزيل المسافات الزائدة من عناوين الأعمدة
            transformHeader: function(h) {
                return h.trim();
            },
            complete: function(results) {
                if (results.data && results.data.length > 0) {
                    allData = results.data;
                    foundHeaders = results.meta.fields; // حفظ أسماء الأعمدة
                    
                    console.log("الأعمدة الموجودة في الملف:", foundHeaders); // للمطور للمراجعة

                    document.getElementById('last-update').innerText = "تحديث: " + new Date().toLocaleTimeString('ar-EG');
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';

                    updateDashboard(allData, "عرض جميع السجلات");
                } else {
                    alert("لم يتم العثور على بيانات في الملف.");
                }
            },
            error: function(err) {
                console.error(err);
                alert("خطأ في التحميل.");
            }
        });
    }

    // دالة مساعدة للبحث عن القيمة بأكثر من اسم محتمل
    function getVal(row, keys) {
        for (let key of keys) {
            if (row[key] !== undefined) return row[key];
        }
        return '-'; // إذا لم يجد شيئاً
    }

    function applyDateFilter() {
        const selectedDate = document.getElementById('dateFilter').value;
        if (!selectedDate) { alert("يرجى اختيار تاريخ."); return; }

        const filteredData = allData.filter(row => {
            // نحاول قراءة التاريخ من عدة مسميات محتملة
            const dateStr = getVal(row, ['التاريخ', 'تاريخ', 'Date']);
            if (dateStr === '-') return false;

            const rowDateObj = new Date(dateStr);
            const selectedDateObj = new Date(selectedDate);
            
            // التأكد من أن التاريخ صالح
            if(isNaN(rowDateObj)) return false;

            return (
                rowDateObj.getFullYear() === selectedDateObj.getFullYear() &&
                rowDateObj.getMonth() === selectedDateObj.getMonth() &&
                rowDateObj.getDate() === selectedDateObj.getDate()
            );
        });

        if (filteredData.length === 0) {
            alert("لا توجد بيانات لهذا التاريخ: " + selectedDate);
        } else {
            updateDashboard(filteredData, "سجلات يوم: " + selectedDate);
        }
    }

    function resetFilter() {
        document.getElementById('dateFilter').value = '';
        updateDashboard(allData, "عرض جميع السجلات");
    }

    function updateDashboard(data, title) {
        document.getElementById('tableTitle').innerText = title;

        // تصفية البيانات التي لا تحتوي على اسم (فارغة)
        const cleanData = data.filter(r => getVal(r, ['الاسم', 'اسم الموظف']) !== '-');

        // الإحصائيات
        const totalRows = cleanData.length;
        
        // حساب نوع العمل
        let siteCount = 0;
        let officeCount = 0;
        cleanData.forEach(r => {
            const workType = getVal(r, ['نوع العمل', 'طبيعة العمل']);
            if (workType.includes('موقع')) siteCount++;
            if (workType.includes('مكتب')) officeCount++;
        });

        const uniqueNames = [...new Set(cleanData.map(item => getVal(item, ['الاسم', 'اسم الموظف'])))].length;

        document.getElementById('total-rows').innerText = totalRows;
        document.getElementById('site-work').innerText = siteCount;
        document.getElementById('office-work').innerText = officeCount;
        document.getElementById('unique-names').innerText = uniqueNames;

        // تحديث الجدول
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = "";
        
        const displayData = cleanData.slice().reverse(); 
        
        displayData.forEach(row => {
            const tr = document.createElement('tr');
            
            // جلب البيانات باستخدام الدالة المرنة
            const dateVal = getVal(row, ['التاريخ', 'Date']);
            const company = getVal(row, ['الشركة', 'اسم الشركة', 'العميل']);
            const name = getVal(row, ['الاسم', 'اسم الموظف']);
            const typeWork = getVal(row, ['نوع العمل', 'طبيعة العمل']);
            const status = getVal(row, ['حالة اليوم', 'الحالة']);
            const details = getVal(row, ['تفاصيل النشاط', 'التفاصيل', 'ملاحظات']);
            
            // هنا المشكلة غالباً: نبحث عن عدة احتمالات للاسم
            const device = getVal(row, ['نوع الجهاز', 'الجهاز', 'device']); 
            const transport = getVal(row, ['وسيلة المواصلات', 'المواصلات', 'transport']);

            let badgeClass = 'bg-secondary';
            if (typeWork.includes('موقع')) badgeClass = 'bg-success';
            else if (typeWork.includes('مكتب')) badgeClass = 'bg-warning text-dark';

            tr.innerHTML = `
                <td><strong>${dateVal}</strong></td>
                <td>${company}</td>
                <td>${name}</td>
                <td><span class="badge ${badgeClass}">${typeWork}</span></td>
                <td>${status}</td>
                <td class="text-wrap" style="max-width: 300px; font-size: 0.85rem;">${details}</td>
                <td class="fw-bold text-primary">${device}</td>
                <td class="fw-bold text-info">${transport}</td>
            `;
            tableBody.appendChild(tr);
        });

        renderCharts(siteCount, officeCount, cleanData);
    }

    function renderCharts(site, office, data) {
        if (chart1Instance) chart1Instance.destroy();
        if (chart2Instance) chart2Instance.destroy();

        const ctx1 = document.getElementById('workTypeChart').getContext('2d');
        chart1Instance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['زيارات ميدانية', 'عمل مكتبي'],
                datasets: [{
                    data: [site, office],
                    backgroundColor: ['#198754', '#ffc107']
                }]
            },
            options: { maintainAspectRatio: false }
        });

        // تجميع البيانات حسب الشركة
        const companyCounts = {};
        data.forEach(row => {
            const ent = getVal(row, ['الشركة', 'اسم الشركة', 'المنطقة']);
            if(ent !== '-') companyCounts[ent] = (companyCounts[ent] || 0) + 1;
        });

        const ctx2 = document.getElementById('regionChart').getContext('2d');
        chart2Instance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(companyCounts),
                datasets: [{
                    label: 'عدد الأنشطة',
                    data: Object.values(companyCounts),
                    backgroundColor: '#0d6efd'
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // دالة لمساعدة المستخدم في معرفة أسماء الأعمدة الصحيحة
    function debugColumns() {
        if(foundHeaders.length > 0) {
            alert("أسماء الأعمدة التي تم العثور عليها في الملف هي:\n\n" + foundHeaders.join("\n"));
        } else {
            alert("لم يتم تحميل البيانات بعد.");
        }
    }

    init();
</script>

</body>
</html>
ما الذي يجب فعله إذا استمرت المشكلة؟

شغل الكود أعلاه.

انظر للجدول، إذا كانت الأعمدة "نوع الجهاز" أو "المواصلات" فارغة (تظهر شرطة -).

اضغط على الزر الجديد الذي أضفته بجانب عنوان الجدول المسمى: "فحص أسماء الأعمدة".

ستظهر لك رسالة بكل الأسماء الموجودة في ملفك.

إذا رأيت مثلاً: نوع الجهاز (مع مسافة) -> الكود الجديد عالج هذه المشكلة.

إذا رأيت اسماً مختلفاً تماماً (مثلاً: الجهاز المستخدم)، يجب عليك تغيير الاسم في ملف Google Sheet ليطابق نوع الجهاز أو تخبرني بالاسم الظاهر لأعدل الكود.

ملاحظة: الكود أعلاه يبحث عن نوع الجهاز أو الجهاز، ويبحث عن وسيلة المواصلات أو المواصلات، لزيادة فرص ظهور البيانات.
